@page
@model GenderHealthcareServiceManagementSystemPages.Pages.Admin.DashboardModel
@{
    ViewData["Title"] = "Thống kê";
}

<style>
    body {
        background: linear-gradient(to bottom right, #f9f3ff, #ffeaf7, #ebf0ff);
    }

    .gradient-text {
        background: linear-gradient(to right, #9333ea, #ec4899);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-weight: bold;
    }
</style>

<div class="dashboard-grid">
    <h1 class="gradient-text mb-3" style="width:fit-content;padding:5px">Thống kê</h1>
    <form method="get" class="row g-2 mb-4">
        <div class="col-md-3">
            <label for="sortType" class="form-label">Lọc theo</label>
            <select id="sortType" name="SortType" class="form-select">
                <option value="">-- Tất cả --</option>
                @if (Model.SortType == "day")
                {
                    <option value="day" selected>Ngày</option>
                }
                else
                {
                    <option value="day">Ngày</option>
                }
                @if (Model.SortType == "month")
                {
                    <option value="month" selected>Tháng</option>
                }
                else
                {
                    <option value="month">Tháng</option>
                }
                @if (Model.SortType == "year")
                {
                    <option value="year" selected>Năm</option>
                }
                else
                {
                    <option value="year">Năm</option>
                }
            </select>
        </div>
        <div class="col-md-3">
            <label for="selectedDate" class="form-label">Chọn ngày/tháng/năm</label>
            <input id="selectedDate" name="SelectedDate" type="date" class="form-control" value="@(Model.SelectedDate?.ToString("yyyy-MM-dd"))" />
        </div>
        <div class="col-md-2 d-flex align-items-end">
            <button type="submit" class="btn btn-primary">Lọc</button>
        </div>
    </form>
    <div class="metric-grid mb-4">
        <div class="dashboard-card">
            <div class="dashboard-card-header">
                <span class="dashboard-card-title">Tổng số lượng xét nghiệm</span>
            </div>
            <div class="dashboard-card-value" style="font-size:2rem">@Model.TotalTestCount</div>
        </div>
        <div class="dashboard-card">
            <div class="dashboard-card-header">
                <span class="dashboard-card-title">Số lượng từng loại xét nghiệm</span>
            </div>
            <ul class="list-group list-group-flush">
                @foreach (var item in Model.TestCountByType)
                {
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>@item.ServiceName</span>
                        <span class="badge bg-primary rounded-pill">@item.Count</span>
                    </li>
                }
            </ul>
        </div>
    </div>

    <!-- Các chỉ số tổng quát -->
    <div class="metric-grid">
        @foreach (var metric in Model.Metrics)
        {
            <div class="dashboard-card">
                <div class="dashboard-card-header">
                    <p class="dashboard-card-title">@metric.Title</p>
                    <span></span>
                </div>
                <div class="dashboard-card-value">@metric.Value</div>
                <p class="dashboard-card-description">@metric.Description</p>
            </div>
        }
    </div>

    <!-- Đặt lịch gần đây và phản hồi -->
    <div class="metric-grid">

        <!-- Lịch hẹn dịch vụ gần đây -->
        <div class="dashboard-card">
            <div class="dashboard-card-header">
                <h3>Đặt lịch dịch vụ gần đây</h3>
            </div>
            <div class="dashboard-card-description">Các lượt đặt lịch gần nhất cho các dịch vụ khác nhau.</div>
            <!-- Hottest Service Section -->
            <div class="hottest-service-section">
                <p class="hottest-service-title">Dịch vụ hot nhất:</p>
                <span class="hottest-service-value">@Model.HottestService</span>
            </div>
            <div class="dashboard-table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Mã lịch hẹn</th>
                            <th>Dịch vụ</th>
                            <th>Người dùng</th>
                            <th>Ngày</th>
                            <th class="text-right">Trạng thái</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var booking in Model.RecentBookings)
                        {
                            var statusClass = booking.Status switch
                            {
                                "Completed" => "dashboard-badge completed",
                                "Pending" => "dashboard-badge pending",
                                _ => "dashboard-badge cancelled"
                            };
                            var statusText = booking.Status switch
                            {
                                "Completed" => "Hoàn thành",
                                "Pending" => "Đang chờ",
                                _ => "Đã hủy"
                            };
                            <tr>
                                <td>@booking.Id</td>
                                <td>@booking.Service</td>
                                <td>@booking.User</td>
                                <td>@booking.Date</td>
                                <td class="text-right">
                                    <span class="@statusClass">@statusText</span>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Phản hồi mới nhất -->
        <div class="dashboard-card">
            <div class="dashboard-card-header">
                <h3>Phản hồi người dùng gần đây</h3>
            </div>
            <div class="dashboard-card-description">
                Các bình luận và đánh giá gần đây từ người dùng.
                @if (Model.FeedbackCount > 0)
                {
                    <div class="average-rating-display">
                        <span class="average-rating-value">@Model.AverageRating.ToString("0.0")</span>
                        <div class="star-display">
                            @{
                                int fullStars = (int)Math.Floor(Model.AverageRating);
                                bool hasHalfStar = Model.AverageRating - fullStars >= 0.5;
                                int emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
                            }
                            @for (int i = 0; i < fullStars; i++)
                            {
                                <i class="bi bi-star-fill text-warning me-1"></i>
                            }
                            @if (hasHalfStar)
                            {
                                <i class="bi bi-star-half text-warning me-1"></i>
                            }
                            @for (int i = 0; i < emptyStars; i++)
                            {
                                <i class="bi bi-star text-muted me-1"></i>
                            }
                        </div>
                        <span class="feedback-count">(@Model.FeedbackCount đánh giá)</span>
                    </div>
                }
            </div>


            <!-- Filter Controls for Feedback -->
            @*  <div class="feedback-filters">
                <form method="get" class="filter-form">
                    <div class="filter-group">
                        <label for="reviewCount">Số đánh giá:</label>
                        <input type="number" id="reviewCount" name="reviewCount" value="@Model.SelectedReviewCount" min="1" class="form-control" onchange="this.form.submit()" />
                    </div>
                    <div class="filter-group">
                        <label for="startDate">Từ ngày:</label>
                        <input type="date" id="startDate" name="startDate" value="@(Model.StartDate?.ToString("yyyy-MM-dd"))" class="form-control" onchange="this.form.submit()" />
                    </div>
                    <div class="filter-group">
                        <label for="endDate">Đến ngày:</label>
                        <input type="date" id="endDate" name="endDate" value="@(Model.EndDate?.ToString("yyyy-MM-dd"))" class="form-control" onchange="this.form.submit()" />
                    </div> *@
            @* Keep existing query parameters if any, e.g., for other sections of the dashboard *@
            @*   @foreach (var queryParam in Context.Request.Query)
                    {
                        @if (queryParam.Key != "reviewCount" && queryParam.Key != "startDate" && queryParam.Key != "endDate")
                        {
                            <input type="hidden" name="@queryParam.Key" value="@queryParam.Value" />
                        }
                    }
                </form>
            </div> *@

            <div class="dashboard-table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Người dùng</th>
                            <th>Đánh giá</th>
                            <th>Bình luận</th>
                            <th class="text-right">Ngày</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.LatestFeedback == null || !Model.LatestFeedback.Any())
                        {
                            <tr>
                                <td colspan="4" class="text-center text-muted">Không có phản hồi nào gần đây.</td>
                            </tr>
                        }
                        else
                        {
                            @foreach (var feedback in Model.LatestFeedback)
                            {
                                <tr>
                                    <td>@feedback.User.Username</td>
                                    <td>
                                        <div>
                                            @for (int i = 0; i < feedback.Rating; i++)
                                            {
                                                <i class="bi bi-star-fill text-warning me-1"></i>
                                            }
                                            @for (int i = feedback.Rating ?? 0; i < 5; i++)
                                            {
                                                <i class="bi bi-star text-muted me-1"></i>
                                            }
                                        </div>
                                    </td>
                                    <td class="dashboard-truncate" title="@feedback.FeedbackText">
                                        @feedback.FeedbackText
                                    </td>
                                    <td class="text-right">@feedback.CreatedAt</td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Bảng danh sách xét nghiệm -->
    <div class="card mt-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Danh sách xét nghiệm</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Mã XN</th>
                            <th>Tên xét nghiệm</th>
                            <th>Bệnh nhân</th>
                            <th>Ngày hẹn</th>
                            <th>Trạng thái</th>
                            <th>Chuyên gia phụ trách</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.TestsWithConsultants.Any())
                        {
                            @foreach (var test in Model.TestsWithConsultants)
                            {
                                <tr>
                                    <td>XN-@test.TestId</td>
                                    <td>@test.TestName</td>
                                    <td>@test.PatientName</td>
                                    <td>@test.AppointmentTime.ToString("dd/MM/yyyy HH:mm")</td>
                                    <td>
                                        <span class="badge @(test.Status == "Hoàn thành" ? "bg-success" :
                                                                                                     test.Status == "Đang xử lý" ? "bg-warning" :
                                                                                                     "bg-secondary")">
                                    @test.Status
                                </span>
                            </td>
                            @* <td>@test.ConsultantName</td> *@
                        </tr>
                                                }
                        }
                        else
                        {
                            <tr>
                                <td colspan="6" class="text-center">Không có dữ liệu xét nghiệm</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/Dashboard.css?v=20250717" />
}

