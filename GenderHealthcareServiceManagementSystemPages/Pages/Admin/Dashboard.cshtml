@page
@model GenderHealthcareServiceManagementSystemPages.Pages.Admin.DashboardModel
@{
    ViewData["Title"] = "Thống kê";
}

<style>
    body {
        background: linear-gradient(to bottom right, #f9f3ff, #ffeaf7, #ebf0ff);
    }

    .gradient-text {
        background: linear-gradient(to right, #9333ea, #ec4899);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-weight: bold;
    }
</style>

<div class="dashboard-grid">
    <h1 class="gradient-text mb-3" style="width:fit-content;padding:5px">Thống kê</h1>

    <!-- Các chỉ số tổng quát -->
    <div class="metric-grid">
        @foreach (var metric in Model.Metrics)
        {
            <div class="dashboard-card">
                <div class="dashboard-card-header">
                    <p class="dashboard-card-title">@metric.Title</p>
                    <span>@* Thay thế bằng biểu tượng nếu cần *@</span>
                </div>
                <div class="dashboard-card-value">@metric.Value</div>
                <p class="dashboard-card-description">@metric.Description</p>
            </div>
        }
    </div>

    <!-- Đặt lịch gần đây và phản hồi -->
    <div class="metric-grid">

        <!-- Lịch hẹn dịch vụ gần đây -->
        <div class="dashboard-card">
            <div class="dashboard-card-header">
                <h3>Đặt lịch dịch vụ gần đây</h3>
            </div>
            <div class="dashboard-card-description">Các lượt đặt lịch gần nhất cho các dịch vụ khác nhau.</div>
            <!-- Hottest Service Section -->
            <div class="hottest-service-section">
                <p class="hottest-service-title">Dịch vụ hot nhất:</p>
                <span class="hottest-service-value">@Model.HottestService</span>
            </div>
            <div class="dashboard-table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Mã lịch hẹn</th>
                            <th>Dịch vụ</th>
                            <th>Người dùng</th>
                            <th>Ngày</th>
                            <th class="text-right">Trạng thái</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var booking in Model.RecentBookings)
                        {
                            var statusClass = booking.Status switch
                            {
                                "Completed" => "dashboard-badge completed",
                                "Pending" => "dashboard-badge pending",
                                _ => "dashboard-badge cancelled"
                            };
                            var statusText = booking.Status switch
                            {
                                "Completed" => "Hoàn thành",
                                "Pending" => "Đang chờ",
                                _ => "Đã hủy"
                            };
                            <tr>
                                <td>@booking.Id</td>
                                <td>@booking.Service</td>
                                <td>@booking.User</td>
                                <td>@booking.Date</td>
                                <td class="text-right">
                                    <span class="@statusClass">@statusText</span>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Phản hồi mới nhất -->
        <div class="dashboard-card">
            <div class="dashboard-card-header">
                <h3>Phản hồi người dùng gần đây</h3>
            </div>
            <div class="dashboard-card-description">
                Các bình luận và đánh giá gần đây từ người dùng.
                @if (Model.FeedbackCount > 0)
                {
                    <div class="average-rating-display">
                        <span class="average-rating-value">@Model.AverageRating.ToString("0.0")</span>
                        <div class="star-display">
                            @{
                                int fullStars = (int)Math.Floor(Model.AverageRating);
                                bool hasHalfStar = Model.AverageRating - fullStars >= 0.5;
                                int emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
                            }
                            @for (int i = 0; i < fullStars; i++)
                            {
                                <i class="bi bi-star-fill text-warning me-1"></i>
                            }
                            @if (hasHalfStar)
                            {
                                <i class="bi bi-star-half text-warning me-1"></i>
                            }
                            @for (int i = 0; i < emptyStars; i++)
                            {
                                <i class="bi bi-star text-muted me-1"></i>
                            }
                        </div>
                        <span class="feedback-count">(@Model.FeedbackCount đánh giá)</span>
                    </div>
                }
            </div>


            <!-- Filter Controls for Feedback -->
           @*  <div class="feedback-filters">
                <form method="get" class="filter-form">
                    <div class="filter-group">
                        <label for="reviewCount">Số đánh giá:</label>
                        <input type="number" id="reviewCount" name="reviewCount" value="@Model.SelectedReviewCount" min="1" class="form-control" onchange="this.form.submit()" />
                    </div>
                    <div class="filter-group">
                        <label for="startDate">Từ ngày:</label>
                        <input type="date" id="startDate" name="startDate" value="@(Model.StartDate?.ToString("yyyy-MM-dd"))" class="form-control" onchange="this.form.submit()" />
                    </div>
                    <div class="filter-group">
                        <label for="endDate">Đến ngày:</label>
                        <input type="date" id="endDate" name="endDate" value="@(Model.EndDate?.ToString("yyyy-MM-dd"))" class="form-control" onchange="this.form.submit()" />
                    </div> *@
                    @* Keep existing query parameters if any, e.g., for other sections of the dashboard *@
                  @*   @foreach (var queryParam in Context.Request.Query)
                    {
                        @if (queryParam.Key != "reviewCount" && queryParam.Key != "startDate" && queryParam.Key != "endDate")
                        {
                            <input type="hidden" name="@queryParam.Key" value="@queryParam.Value" />
                        }
                    }
                </form>
            </div> *@

            <div class="dashboard-table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Người dùng</th>
                            <th>Đánh giá</th>
                            <th>Bình luận</th>
                            <th class="text-right">Ngày</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.LatestFeedback == null || !Model.LatestFeedback.Any())
                        {
                            <tr>
                                <td colspan="4" class="text-center text-muted">Không có phản hồi nào gần đây.</td>
                            </tr>
                        }
                        else
                        {
                            @foreach (var feedback in Model.LatestFeedback)
                            {
                                <tr>
                                    <td>@feedback.User.Username</td>
                                    <td>
                                        <div>
                                            @for (int i = 0; i < feedback.Rating; i++)
                                            {
                                                <i class="bi bi-star-fill text-warning me-1"></i>
                                            }
                                            @for (int i = feedback.Rating ?? 0; i < 5; i++)
                                            {
                                                <i class="bi bi-star text-muted me-1"></i>
                                            }
                                        </div>
                                    </td>
                                    <td class="dashboard-truncate" title="@feedback.FeedbackText">
                                        @feedback.FeedbackText
                                    </td>
                                    <td class="text-right">@feedback.CreatedAt</td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/Dashboard.css?v=20250717" />
}

